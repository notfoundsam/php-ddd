services:
  db:
    image: mysql:8.0.42
    command: mysqld --sql_mode="NO_ENGINE_SUBSTITUTION" --authentication_policy=mysql_native_password
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=ebdb
    volumes:
      - php-ddd-db:/var/lib/mysql
    ports:
      - "3340:3306"
    networks:
      - php-ddd
  mail:
    platform: linux/amd64
    image: mailhog/mailhog
    ports:
      - "1080:8025"
    networks:
      - php-ddd
  redis:
    image: redis:7.4.2
    networks:
      - php-ddd
    ports:
      - "6379:6379"
  nginx:
    build:
      context: ./fuelphp/docker/localhost
      dockerfile: nginx.dockerfile
    ports:
      - "8080:80"
    volumes:
      - ./fuelphp/docker/nginx.conf:/etc/nginx/nginx.conf
      - ./fuelphp/docker/localhost/nginx_default.conf:/etc/nginx/conf.d/default.conf
      - ./fuelphp/public:/app/fuelphp/public
    networks:
      - php-ddd
    depends_on:
      - fuelphp
  fuelphp:
    build:
      context: ./fuelphp/docker
      dockerfile: localhost/php.dockerfile
    environment:
      FUEL_ENV: development
      APP_URL: http://localhost:8080
      RDS_HOSTNAME: db
      RDS_PORT: 3306
      RDS_DB_NAME: ebdb
      RDS_USERNAME: root
      RDS_PASSWORD: root
      PHP_MEMORY_LIMIT: 256M

      # IDE config
      PHP_IDE_CONFIG: serverName=Docker
    volumes:
      - ./:/app
    networks:
      - php-ddd
    depends_on:
      - redis
      - db
      - mail

networks:
  php-ddd:
    driver: bridge

volumes:
  php-ddd-db:
